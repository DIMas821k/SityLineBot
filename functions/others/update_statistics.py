import sqlite3
from config import  database_path

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite
conn = sqlite3.connect(database_path)  # –ó–∞–º–µ–Ω–∏—Ç–µ 'database.db' –Ω–∞ –∏–º—è –≤–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
cursor = conn.cursor()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
def recalculate_statistics(user_id):
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    total_statistics = {
        "—Ä–∞–±–æ—Ç—è–≥–∏": 0,
        "—ç–Ω–µ—Ä–≥–∏—è": 0,
        "–∂–∏—Ç–µ–ª–∏": 0,
        "–≤–æ–¥–∞": 0,
        "–¥–æ—Ä–æ–≥–∏": 0,
        "–ü—Ä–∏–±—ã–ª—å": 0,
        "–ü—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π_–º—É—Å–æ—Ä": 0,
        "exp": 0
    }

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ —Å –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
    cursor.execute("SELECT –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ä–∞–±–æ—Ç—è–≥–∏, —ç–Ω–µ—Ä–≥–∏—è, –∂–∏—Ç–µ–ª–∏, –≤–æ–¥–∞, –¥–æ—Ä–æ–≥–∏, –ü—Ä–∏–±—ã–ª—å, –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π_–º—É—Å–æ—Ä, exp FROM –ü–æ—Å—Ç—Ä–æ–π–∫–∏")
    buildings_stats = cursor.fetchall()

    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞–±–ª–∏—Ü—ã buildings
    cursor.execute("PRAGMA table_info(buildings)")
    buildings_columns = [column[1] for column in cursor.fetchall()]

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–¥–∞–Ω–∏–π —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute(f"SELECT * FROM buildings WHERE id = ?", (user_id,))
    user_buildings = cursor.fetchone()

    if user_buildings is None:
        print(f"–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å id {user_id} –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–¥–∞–Ω–∏—è–º.")
        return

    # –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –∑–¥–∞–Ω–∏–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ü–æ—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–æ–ª–µ–π —Ç–∞–±–ª–∏—Ü—ã buildings
    building_name_to_column = {
        "–ü—Ä–æ—Å—Ç–æ–π –¥–æ–ºüè†": "–ü—Ä–æ—Å—Ç–æ–π_–¥–æ–ºüè†",
        "–ö–∏—Ä–ø–∏—á–Ω—ã–π –¥–æ–ºüè°": "–ö–∏—Ä–ø–∏—á–Ω—ã–π_–¥–æ–ºüè°",
        "–ú–∞–ª—ã–π –∑–∞–≤–æ–¥üè≠": "–ú–∞–ª—ã–π_–∑–∞–≤–æ–¥üè≠",
        "–ú–∞–≥–∞–∑–∏–Ωüè™": "–ú–∞–≥–∞–∑–∏–Ωüè™",
        "–ö–æ—Å–º–æ–¥—Ä–æ–º": "–ö–æ—Å–º–æ–¥—Ä–æ–º",
        "–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è": "–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è",
        "–í–æ–¥–æ–∑–∞–±–æ—Ä": "–í–æ–¥–æ–∑–∞–±–æ—Ä",
        "–í–æ–¥–æ–æ—á–∏—Å—Ç–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è": "–í–æ–¥–æ–æ—á–∏—Å—Ç–Ω–∞—è_—Å—Ç–∞–Ω—Ü–∏—è",
        "–ì–∏–¥—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è": "–ì–∏–¥—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è_—Å—Ç–∞–Ω—Ü–∏—è",
        "–ú–µ–≥–∞ –≤–æ–¥–æ–∑–∞–±–æ—Ä": "–ú–µ–≥–∞_–≤–æ–¥–æ–∑–∞–±–æ—Ä",
        # –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–¥–∞–Ω–∏–π, –∫–∞–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    }

    # –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–º –∑–¥–∞–Ω–∏—è–º –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    for building in buildings_stats:
        name, —Ä–∞–±–æ—Ç—è–≥–∏, —ç–Ω–µ—Ä–≥–∏—è, –∂–∏—Ç–µ–ª–∏, –≤–æ–¥–∞, –¥–æ—Ä–æ–≥–∏, –ü—Ä–∏–±—ã–ª—å, –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π_–º—É—Å–æ—Ä, exp = building
        building_column = building_name_to_column.get(name)

        if building_column and building_column in buildings_columns:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∑–¥–∞–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö SELECT
            count_index = buildings_columns.index(building_column)
            count = user_buildings[count_index]

            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —É—á–∏—Ç—ã–≤–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–¥–∞–Ω–∏–π
            total_statistics["—Ä–∞–±–æ—Ç—è–≥–∏"] += —Ä–∞–±–æ—Ç—è–≥–∏ * count
            total_statistics["—ç–Ω–µ—Ä–≥–∏—è"] += —ç–Ω–µ—Ä–≥–∏—è * count
            total_statistics["–∂–∏—Ç–µ–ª–∏"] += –∂–∏—Ç–µ–ª–∏ * count
            total_statistics["–≤–æ–¥–∞"] += –≤–æ–¥–∞ * count
            total_statistics["–¥–æ—Ä–æ–≥–∏"] += –¥–æ—Ä–æ–≥–∏ * count
            total_statistics["–ü—Ä–∏–±—ã–ª—å"] += –ü—Ä–∏–±—ã–ª—å * count
            total_statistics["–ü—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π_–º—É—Å–æ—Ä"] += –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π_–º—É—Å–æ—Ä * count
            total_statistics["exp"] += exp * count

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É statistic
    cursor.execute("""
        UPDATE statistic 
        SET —Ä–∞–±–æ—Ç—è–≥–∏ = ?, —ç–Ω–µ—Ä–≥–∏—è = ?, –∂–∏—Ç–µ–ª–∏ = ?, –≤–æ–¥–∞ = ?, –¥–æ—Ä–æ–≥–∏ = ?, –ü—Ä–∏–±—ã–ª—å = ?, –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π_–º—É—Å–æ—Ä = ?, exp = ?
        WHERE id = ?
    """, (
        total_statistics["—Ä–∞–±–æ—Ç—è–≥–∏"],
        total_statistics["—ç–Ω–µ—Ä–≥–∏—è"],
        total_statistics["–∂–∏—Ç–µ–ª–∏"],
        total_statistics["–≤–æ–¥–∞"],
        total_statistics["–¥–æ—Ä–æ–≥–∏"],
        total_statistics["–ü—Ä–∏–±—ã–ª—å"],
        total_statistics["–ü—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π_–º—É—Å–æ—Ä"],
        total_statistics["exp"],
        user_id
    ))

    conn.commit()

# –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å id = 1
recalculate_statistics(1765556370)

# –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
conn.close()
